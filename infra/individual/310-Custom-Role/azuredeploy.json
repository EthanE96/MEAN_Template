{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "managedIdentityName": { "type": "string" }
  },
  "resources": [
    // Create the custom role definition
    {
      "type": "Microsoft.Authorization/roleDefinitions",
      "apiVersion": "2022-04-01",
      "name": "Cosmos DB Connection String Reader",
      "properties": {
        "roleName": "Cosmos DB Connection String Reader",
        "description": "Can list connection strings for Cosmos DB accounts.",
        "assignableScopes": [
          "[subscription().id]"
        ],
        "permissions": [
          {
            "actions": [
              "Microsoft.DocumentDB/databaseAccounts/listConnectionStrings/action"
            ],
            "notActions": [],
            "dataActions": [],
            "notDataActions": []
          }
        ]
      }
    },
    // Assign the custom role to the managed identity using nested template
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "roleAssignNested",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://mgmt1storage.blob.core.windows.net/arm-templates/id-nested.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "roleAssignmentName": {
            "value": "[guid(resourceGroup().id, parameters('managedIdentityName'), 'CosmosDBConnectionStringReader')]"
          },
          "roleDefinitionId": {
            "value": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'Cosmos DB Connection String Reader')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2023-01-31').principalId]"
          },
          "scope": {
            "value": "[subscription().id]"
          }
        }
      },
      "dependsOn": [
        "Cosmos DB Connection String Reader"
      ]
    }
  ]
}
